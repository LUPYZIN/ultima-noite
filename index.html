<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>A ÚLTIMA NOITE</title>
  <style>
    body {
      background-color: #0d0d0d;
      color: #e0e0e0;
      font-family: "Courier New", monospace;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      text-align: center;
      margin-top: 20px;
    }

    .panel {
      background: rgba(30, 30, 30, 0.95);
      border: 1px solid #444;
      border-radius: 10px;
      padding: 15px;
      margin: 10px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 0 10px #000;
    }

    input, button, select {
      background: #111;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 8px;
      margin: 5px;
      width: calc(100% - 12px);
    }

    button:hover {
      background: #222;
      cursor: pointer;
    }

    .inventory, .log, .crafting, .skills {
      margin-top: 10px;
      font-size: 0.95em;
    }

    .craft-item {
      background: #1a1a1a;
      margin: 4px;
      padding: 6px;
      border-radius: 5px;
      border: 1px solid #333;
    }

    @media (max-width: 600px) {
      body { font-size: 0.9em; }
    }
  </style>
</head>
<body>

  <header>
    <h1>🕯️ A ÚLTIMA NOITE 🕯️</h1>
    <p>Mansão velha e isolada no meio do deserto</p>
  </header>

  <div class="panel" id="loginPanel">
    <h3>Entrar no jogo</h3>
    <input id="nickname" placeholder="Seu nickname" />
    <input id="roomId" placeholder="ID da sala (ex: sala1)" />
    <button id="joinRoomBtn">Entrar / Criar Sala</button>
  </div>

  <div class="panel" id="gamePanel" style="display:none;">
    <h3 id="roomTitle"></h3>
    <p><b>Jogadores na sala:</b> <span id="playerList"></span></p>

    <div class="inventory">
      <h4>🎒 Inventário</h4>
      <div id="inventoryList"></div>
      <button id="rollDiceBtn">🎲 Rodar dado (buscar item)</button>
    </div>

    <div class="crafting">
      <h4>⚒️ Crafting</h4>
      <div id="craftList"></div>
    </div>

    <div class="skills">
      <h4>💪 Skills</h4>
      <div id="skillsList"></div>
    </div>

    <div class="log">
      <h4>📜 Log</h4>
      <div id="logBox"></div>
    </div>
  </div>

  <script type="module">
    // ======= FIREBASE CONFIG =======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, update, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAgzXg_2xhAOfPAA7DhE4lq5MLFEmJVGJs",
      authDomain: "ultima-noite-f2867.firebaseapp.com",
      projectId: "ultima-noite-f2867",
      storageBucket: "ultima-noite-f2867.firebasestorage.app",
      messagingSenderId: "553820660993",
      appId: "1:553820660993:web:cb1019cc2361a54e4c6700",
      measurementId: "G-J8XZBFZH32",
      databaseURL: "https://ultima-noite-f2867-default-rtdb.europe-west1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ======= GAME VARIABLES =======
    let nickname = "";
    let roomId = "";
    let playerRef;
    let inventory = [];

    const ITEMS = [
      "Madeira", "Galhos secos", "Metal enferrujado", "Pano velho", "Pregos",
      "Enlatados", "Água mineral", "Isqueiro", "Martelo", "Corda",
      "Lanterna", "Curativos", "Faca", "Taco de beisebol", "Diário misterioso"
    ];

    const RECIPES = [
      { result: "Fogueira", requires: ["Madeira", "Isqueiro"] },
      { result: "Tocha", requires: ["Galhos secos", "Pano velho", "Isqueiro"] },
      { result: "Kit de Reparos", requires: ["Metal enferrujado", "Pregos", "Martelo"] },
      { result: "Filtro de Água", requires: ["Pano velho", "Água mineral"] },
    ];

    const SKILLS = [
      { name: "Sobrevivente Experiente", desc: "Roda 1d2 a cada 3 turnos e ganha +1 item se cair 2.", cooldown: 3, turns: 0 }
    ];

    // ======= UI ELEMENTS =======
    const loginPanel = document.getElementById("loginPanel");
    const gamePanel = document.getElementById("gamePanel");
    const roomTitle = document.getElementById("roomTitle");
    const playerList = document.getElementById("playerList");
    const inventoryList = document.getElementById("inventoryList");
    const rollDiceBtn = document.getElementById("rollDiceBtn");
    const logBox = document.getElementById("logBox");
    const craftList = document.getElementById("craftList");
    const skillsList = document.getElementById("skillsList");

    // ======= JOIN ROOM =======
    document.getElementById("joinRoomBtn").onclick = async () => {
      nickname = document.getElementById("nickname").value.trim();
      roomId = document.getElementById("roomId").value.trim();
      if (!nickname || !roomId) return alert("Preencha nickname e ID da sala.");

      const roomRef = ref(db, `rooms/${roomId}`);
      const snapshot = await get(roomRef);
      if (!snapshot.exists()) {
        await set(roomRef, { players: {} });
      }

      playerRef = ref(db, `rooms/${roomId}/players/${nickname}`);
      await set(playerRef, { nickname, inventory: [] });

      loginPanel.style.display = "none";
      gamePanel.style.display = "block";
      roomTitle.innerText = `Sala: ${roomId}`;
      log(`🔹 Entrou na sala "${roomId}" como ${nickname}.`);

      listenPlayers(roomRef);
      renderCrafting();
      renderSkills();
    };

    // ======= LISTEN PLAYERS =======
    function listenPlayers(roomRef) {
      onValue(ref(db, `rooms/${roomId}/players`), (snapshot) => {
        const players = snapshot.val() || {};
        playerList.innerText = Object.keys(players).join(", ");
      });
    }

    // ======= ROLL DICE =======
    rollDiceBtn.onclick = async () => {
      const roll = Math.floor(Math.random() * 8) + 1;
      let msg = `🎲 Rolou ${roll}. `;
      if (roll >= 6) {
        const item = ITEMS[Math.floor(Math.random() * ITEMS.length)];
        inventory.push(item);
        await update(playerRef, { inventory });
        msg += `Conseguiu ${item}!`;
      } else if (roll >= 3) {
        msg += "Encontrou algo, mas se machucou levemente.";
      } else {
        msg += "Nada encontrado e sofreu um pequeno acidente.";
      }
      log(msg);
      renderInventory();
      checkSkills();
    };

    // ======= INVENTORY DISPLAY =======
    function renderInventory() {
      inventoryList.innerHTML = inventory.length ? inventory.join(", ") : "Vazio";
    }

    // ======= CRAFTING =======
    function renderCrafting() {
      craftList.innerHTML = "";
      RECIPES.forEach(r => {
        const div = document.createElement("div");
        div.className = "craft-item";
        div.innerHTML = `<b>${r.result}</b> → precisa de: ${r.requires.join(", ")} <br>
        <button>Craftar</button>`;
        div.querySelector("button").onclick = async () => {
          if (r.requires.every(req => inventory.includes(req))) {
            r.requires.forEach(req => inventory.splice(inventory.indexOf(req), 1));
            inventory.push(r.result);
            await update(playerRef, { inventory });
            renderInventory();
            log(`✅ Criou ${r.result}!`);
          } else log("❌ Itens insuficientes.");
        };
        craftList.appendChild(div);
      });
    }

    // ======= SKILLS =======
    function renderSkills() {
      skillsList.innerHTML = "";
      SKILLS.forEach(skill => {
        const div = document.createElement("div");
        div.innerHTML = `<b>${skill.name}</b> - ${skill.desc} (Cooldown: ${skill.cooldown})`;
        skillsList.appendChild(div);
      });
    }

    function checkSkills() {
      SKILLS.forEach(skill => {
        skill.turns++;
        if (skill.turns >= skill.cooldown) {
          skill.turns = 0;
          const roll = Math.floor(Math.random() * 2) + 1;
          if (roll === 2) {
            const item = ITEMS[Math.floor(Math.random() * ITEMS.length)];
            inventory.push(item);
            update(playerRef, { inventory });
            log(`⭐ Skill "${skill.name}" ativou! Ganhou ${item}.`);
            renderInventory();
          }
        }
      });
    }

    // ======= LOG DISPLAY =======
    function log(text) {
      const line = document.createElement("div");
      line.textContent = text;
      logBox.prepend(line);
    }

  </script>
</body>
</html>
